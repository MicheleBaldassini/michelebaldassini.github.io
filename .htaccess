RewriteEngine On

# Define REDIRECT_HOST env variable:
# If www is present, use host without www
RewriteCond %{HTTP_HOST} ^www\.(.+)$ [NC]
RewriteRule ^ - [E=REDIRECT_HOST:%1]

# If no www, just use the HTTP_HOST.
RewriteCond %{ENV:REDIRECT_HOST} =""
RewriteRule ^ - [E=REDIRECT_HOST:%{HTTP_HOST}]

# Redirect if not HTTPS or if www is present.
RewriteCond %{HTTP:X-Forwarded-Proto} !https [OR]
RewriteCond %{HTTP_HOST} ^www\.(.+)$ [NC]
RewriteRule ^ https://%{ENV:REDIRECT_HOST}%{REQUEST_URI} [R=301,L]

# Add the final slash on all required directories without slash.
# RewriteCond %{REQUEST_FILENAME} !-f
# RewriteCond %{REQUEST_URI} !\.[a-zA-Z0-9]{2,4}$ 
# RewriteRule ^(.*[^/])$ /$1/ [R=301,L]